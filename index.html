<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu√† nh·ªè cho em</title>
  <style>
    :root{
      --txt:#fff;
      --glass: rgba(0,0,0,.40);
      --stroke: rgba(255,255,255,.22);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--txt); overflow:hidden; }
    body{
      background: url("./2dau.png") center/cover no-repeat fixed;
    }
    .overlay{
      position:fixed; inset:0;
      background:
        radial-gradient(circle at 25% 10%, rgba(255,255,255,.10), transparent 40%),
        linear-gradient(to bottom, rgba(0,0,0,.20), rgba(0,0,0,.60));
      pointer-events:none;
      z-index: 1;
    }

    canvas{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index: 2; }

    /* hearts */
    .heart{
      position:fixed;
      pointer-events:none;
      animation: floatUp linear forwards;
      filter: drop-shadow(0 12px 20px rgba(0,0,0,.35));
      will-change: transform, opacity;
      z-index: 3;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) translateX(0) scale(1); opacity:0; }
      8%{ opacity:1; }
      100%{ transform: translateY(-120vh) translateX(var(--drift)) scale(1.6); opacity:0; }
    }

    /* question box */
    .screen{
      position:fixed; inset:0;
      display:grid; place-items:center;
      z-index: 5;
      padding: 18px;
    }
    .box{
      width:min(760px, 92vw);
      border-radius: 26px;
      background: var(--glass);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 22px;
      text-align:center;
    }
    .q{
      font-weight: 900;
      font-size: clamp(22px, 4vw, 44px);
      margin: 0 0 12px;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .sub{
      margin: 0 0 18px;
      opacity:.95;
      line-height: 1.6;
      font-size: 15px;
    }

    .btn-row{
      display:flex;
      justify-content:center;
      gap: 12px;
      flex-wrap:wrap;
      position:relative;
      min-height: 62px;
    }
    button{
      border:0;
      cursor:pointer;
      padding: 14px 18px;
      border-radius: 16px;
      font-weight: 900;
      font-size: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .14s ease, filter .14s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover{ transform: translateY(-2px); filter: brightness(1.03); }
    button:active{ transform: translateY(0) scale(.98); }

    .btn-yes{
      background: linear-gradient(90deg, #ffffff, #ffe2ee);
      color:#1c1c1c;
    }

    .btn-no{
      background: rgba(255,255,255,.14);
      color:#fff;
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:none;
      position:relative;
    }

    /* Popups */
    .popup{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      z-index: 8;
      padding: 18px;
    }
    .popup.show{ display:grid; }

    .popcard{
      width:min(760px, 92vw);
      border-radius: 26px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.22);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .ptext{
      font-weight: 900;
      font-size: clamp(18px, 3.2vw, 30px);
      margin: 0 0 14px;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .gift-btn{
      background: linear-gradient(90deg, #ffffff, #ffe2ee);
      color:#1c1c1c;
    }

    /* ===== KISS IN POPUP1 ===== */
    .kiss{
      font-size: clamp(48px, 9vw, 96px);
      display:inline-block;
      margin-bottom: 8px;
      animation: kissPulse 0.8s ease-in-out infinite;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,.35));
    }
    @keyframes kissPulse{
      0%   { transform: scale(1.0); }
      40%  { transform: scale(1.25); }
      70%  { transform: scale(0.95); }
      100% { transform: scale(1.22); }
    }

    /* Gift modal with photo */
    .modal{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      z-index: 10;
      padding: 18px;
    }
    .modal.show{ display:grid; }
    .card{
      width:min(980px, 92vw);
      border-radius: 26px;
      background: rgba(0,0,0,.42);
      border:1px solid rgba(255,255,255,.22);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .head{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.16);
    }
    .head b{ font-size: 13px; letter-spacing:.3px; }
    .close{
      background: rgba(255,255,255,.12);
      color:#fff;
      border:1px solid rgba(255,255,255,.22);
      border-radius: 12px;
      padding: 8px 12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:none;
    }

    .photo-wrap{ position:relative; display:grid; place-items:center; background: rgba(0,0,0,.18); }
    .photo-wrap img{
      width:100%;
      height:auto;
      max-height: 74vh;
      object-fit: contain;
      display:block;
      background: rgba(0,0,0,.15);
    }

    /* Sparkling text lines */
    .caption{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom: 14px;
      width:min(92%, 840px);
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.48);
      border: 1px solid rgba(255,255,255,.22);
      overflow:hidden;
    }
    .line{
      display:block;
      font-weight: 950;
      font-size: clamp(16px, 2.4vw, 22px);
      line-height: 1.55;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
      position:relative;
      text-align:center;

      /* v·∫´n gi·ªØ show/transition c≈© */
      opacity: 0;
      transform: translateY(14px);
      transition: opacity .55s ease, transform .55s ease;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 1.55em;
    }
    .line.show{ opacity:1; transform: translateY(0); }

    /* sparkle animation */
    .sparkle{
      background: linear-gradient(110deg,
        rgba(255,255,255,.35) 0%,
        rgba(255,255,255,1) 20%,
        rgba(255,255,255,.35) 40%,
        rgba(255,255,255,.35) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      background-size: 220% 100%;
      animation: shimmer 1.6s linear infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 220% 0; }
      100%{ background-position: -20% 0; }
    }

    /* small hint when autoplay blocked */
    .hint{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 14px;
      z-index: 9;
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.20);
      backdrop-filter: blur(8px);
      display:none;
    }

    /* ====== IMAGE RAIN ====== */
    .rain-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 6;
      display:none;
      overflow:hidden;
    }
    .rain-layer.show{ display:block; }

    .rain-img{
      position:absolute;
      top: -160px;
      width: var(--w);
      transform: rotate(var(--rot));
      opacity: var(--op);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      animation: fall var(--dur) linear forwards;
      border-radius: 10px;
    }
    @keyframes fall{
      0%{ transform: translateY(0) rotate(var(--rot)); }
      100%{ transform: translateY(calc(120vh + 200px)) rotate(var(--rot)); }
    }
  </style>
</head>

<body>
  <div class="overlay"></div>
  <canvas id="fx"></canvas>

  <!-- Image rain layer -->
  <div class="rain-layer" id="rainLayer"></div>

  <!-- Q1 screen -->
  <div class="screen" id="screen">
    <div class="box">
      <div class="q">Em c√≥ y√™u anh kh√¥ng?</div>
      <p class="sub">Tr·∫£ l·ªùi th·∫≠t l√≤ng nha. Anh ch·ªâ h·ªèi m·ªôt c√¢u th√¥i.</p>

      <div class="btn-row" id="btnRow">
        <button class="btn-yes" id="btnYes">C√≥</button>
        <button class="btn-no" id="btnNo">Kh√¥ng</button>
      </div>
    </div>
  </div>

  <!-- Popup 1 (added kiss) -->
  <div class="popup" id="popup1">
    <div class="popcard">
      <div class="kiss" aria-hidden="true">üíã</div>
      <div class="ptext">Anh c≈©ng y√™u emmm</div>
    </div>
  </div>

  <!-- Popup 2 + Open Gift -->
  <div class="popup" id="popup2">
    <div class="popcard">
      <div class="ptext">Anh c√≥ m√≥n qu√† nh·ªè cho emmm, ·∫•n m·ªü qu√† ƒëii</div>
      <button class="gift-btn" id="btnOpenGift">üéÅ M·ªû QU√Ä</button>
    </div>
  </div>

  <!-- Gift modal -->
  <div class="modal" id="modal">
    <div class="card">
      <div class="head">
        <b>üéâ Happy Birthday</b>
        <button class="close" id="btnClose">ƒê√≥ng</button>
      </div>
      <div class="photo-wrap">
        <img src="./anh1.jpg" alt="·∫¢nh k·ª∑ ni·ªám">
        <div class="caption">
          <span class="line sparkle" id="l1"></span>
          <span class="line sparkle" id="l2"></span>
          <span class="line sparkle" id="l3"></span>
          <span class="line sparkle" id="l4"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="hint" id="hint">Tr√¨nh duy·ªát ƒëang ch·∫∑n t·ª± ph√°t nh·∫°c. Em ch·∫°m/b·∫•m 1 c√°i b·∫•t k·ª≥ ƒë·ªÉ b·∫≠t nh·∫°c nh√©.</div>

  <!-- Music local -->
  <audio id="music" loop preload="auto">
    <source src="./anh-nang-cua-anh.mp3" type="audio/mpeg">
  </audio>

  <script>
    /* =========================
       0) WISH LINES (s·ª≠a t·∫°i ƒë√¢y)
       ========================= */
    const WISH_LINES = [
      "Ch√∫c em tu·ªïi m·ªõi lu√¥n r·ª±c r·ª° v√† b√¨nh an.",
      "Lu√¥n c∆∞·ªùi th·∫≠t nhi·ªÅu, lu√¥n ƒë∆∞·ª£c y√™u th∆∞∆°ng th·∫≠t nhi·ªÅu.",
      "M·ªçi ƒëi·ªÅu em mong ƒë·ªÅu s·∫Ω th√†nh hi·ªán th·ª±c.",
      "Sinh nh·∫≠t vui v·∫ª nh√©, c√¥ g√°i c·ªßa anh. ‚ù§Ô∏è"
    ];

    /* =========================
       1) TRY AUTOPLAY MUSIC
       ========================= */
    const music = document.getElementById("music");
    const hint = document.getElementById("hint");
    let musicOn = false;

    async function tryAutoplay(){
      try{
        await music.play();
        musicOn = true;
        hint.style.display = "none";
      }catch(e){
        musicOn = false;
        hint.style.display = "block";
      }
    }

    tryAutoplay();

    async function unlockMusic(){
      if (musicOn) return;
      try{
        await music.play();
        musicOn = true;
        hint.style.display = "none";
      }catch(e){}
    }
    window.addEventListener("pointerdown", unlockMusic, { once:false });

    /* =========================
       2) HEARTS ALWAYS FLOATING (smaller a bit)
       ========================= */
    const heartIcons = ["üíñ","üíó","üíò","üíù","üíû","üíï","‚ù§Ô∏è","‚ú®"];
    function spawnHeart(){
      const h = document.createElement("div");
      h.className = "heart";
      h.textContent = heartIcons[Math.floor(Math.random()*heartIcons.length)];

      const left = Math.random() * window.innerWidth;
      const top  = window.innerHeight + 40;
      const drift = (Math.random()*220 - 110) + "px";
      const dur = (Math.random()*2.4 + 3.2).toFixed(2);

      h.style.left = left + "px";
      h.style.top  = top + "px";
      h.style.setProperty("--drift", drift);
      h.style.animationDuration = dur + "s";

      // gi·ªØ ƒë√∫ng size nh·ªè h∆°n
      h.style.fontSize = (Math.random()*34 + 44).toFixed(0) + "px";

      document.body.appendChild(h);
      setTimeout(()=>h.remove(), (parseFloat(dur)+0.3)*1000);
    }
    setInterval(spawnHeart, 240);

    /* =========================
       3) FIREWORKS ALWAYS (canvas)
       ========================= */
    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d");
    let W=0,H=0,dpr=1;

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      W = canvas.width  = Math.floor(window.innerWidth * dpr);
      H = canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width  = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
    }
    window.addEventListener("resize", resize);
    resize();

    const particles = [];
    function firework(x, y){
      const cx = x*dpr, cy = y*dpr;
      const n = 80;
      for(let i=0;i<n;i++){
        const a = (Math.PI*2)*(i/n);
        const sp = (Math.random()*4.2+2.2)*dpr;
        particles.push({
          x: cx, y: cy,
          vx: Math.cos(a)*sp*(Math.random()*0.7+0.7),
          vy: Math.sin(a)*sp*(Math.random()*0.7+0.7),
          g: 0.032*dpr,
          life: 0, ttl: Math.random()*76+58,
          hue: (Math.random()*360)|0,
          r: (Math.random()*2.2+1.2)*dpr
        });
      }
    }

    setInterval(()=>{
      firework(
        window.innerWidth*(Math.random()*0.7+0.15),
        window.innerHeight*(Math.random()*0.35+0.20)
      );
    }, 380);

    function loop(){
      ctx.clearRect(0,0,W,H);

      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.life++;
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.g;
        p.vx *= 0.985;
        p.vy *= 0.985;

        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        ctx.globalAlpha = Math.max(0, 1 - (p.life/p.ttl));
        ctx.fillStyle = `hsla(${p.hue}, 100%, 70%, 1)`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        if (p.life > p.ttl) particles.splice(i,1);
      }

      requestAnimationFrame(loop);
    }
    loop();

    /* =========================
       4) QUESTION LOGIC: NO MOVES RANDOMLY
       ========================= */
    const btnNo  = document.getElementById("btnNo");
    const btnYes = document.getElementById("btnYes");

    function moveNoButton(){
      const pad = 12;
      const bw = btnNo.offsetWidth || 110;
      const bh = btnNo.offsetHeight || 48;

      const vw = window.innerWidth;
      const vh = window.innerHeight;

      const x = Math.random() * (vw - bw - pad*2) + pad;
      const y = Math.random() * (vh - bh - pad*2) + pad;

      btnNo.style.position = "fixed";
      btnNo.style.left = x + "px";
      btnNo.style.top  = y + "px";
      btnNo.style.zIndex = 7;
    }

    btnNo.addEventListener("mouseenter", moveNoButton);
    btnNo.addEventListener("touchstart", (e)=>{ e.preventDefault(); moveNoButton(); }, {passive:false});
    btnNo.addEventListener("click", (e)=>{ e.preventDefault(); moveNoButton(); });

    /* =========================
       5) YES -> popup1 -> popup2 after 3s
       ========================= */
    const screen = document.getElementById("screen");
    const popup1 = document.getElementById("popup1");
    const popup2 = document.getElementById("popup2");
    const btnOpenGift = document.getElementById("btnOpenGift");

    btnYes.addEventListener("click", async ()=>{
      await unlockMusic();
      screen.style.display = "none";

      popup1.classList.add("show");
      setTimeout(()=>{
        popup1.classList.remove("show");
        popup2.classList.add("show");
      }, 3000);
    });

    /* =========================
       6) IMAGE RAIN (anh2.jpg..anh21.jpg) - infinite
       ========================= */
    const rainLayer = document.getElementById("rainLayer");
    const RAIN_IMAGES = Array.from({length: 20}, (_,i)=> `./anh${i+2}.jpg`); // anh2..anh21
    let rainTimer = null;

    function spawnRainImage(){
      const img = document.createElement("img");
      img.className = "rain-img";

      const src = RAIN_IMAGES[Math.floor(Math.random()*RAIN_IMAGES.length)];
      img.src = src;

      const x = Math.random() * (window.innerWidth + 120) - 60;
      const w = (Math.random()*90 + 60).toFixed(0) + "px"; // 60-150px
      const rot = (Math.random()*24 - 12).toFixed(1) + "deg";
      const op  = (Math.random()*0.35 + 0.55).toFixed(2); // 0.55-0.90
      const dur = (Math.random()*4.2 + 4.0).toFixed(2) + "s"; // 4-8.2s

      img.style.left = x + "px";
      img.style.setProperty("--w", w);
      img.style.setProperty("--rot", rot);
      img.style.setProperty("--op", op);
      img.style.setProperty("--dur", dur);

      rainLayer.appendChild(img);

      const ms = (parseFloat(dur) + 0.4) * 1000;
      setTimeout(()=> img.remove(), ms);
    }

    function startImageRain(){
      if (rainTimer) return;
      rainLayer.classList.add("show");
      rainTimer = setInterval(spawnRainImage, 140);
    }

    /* =========================
       7) OPEN GIFT -> start rain + show modal + TYPEWRITER per character
       ========================= */
    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");

    function resetLines(){
      const els = [
        document.getElementById("l1"),
        document.getElementById("l2"),
        document.getElementById("l3"),
        document.getElementById("l4"),
      ];
      els.forEach(el=>{
        el.textContent = "";
        el.classList.remove("show");
      });
      return els;
    }

    // typewriter each character (t·ª´ng ch·ªØ/ k√Ω t·ª±) for each line sequentially
    function typeLine(el, text, speed=38){
      return new Promise((resolve)=>{
        let i = 0;
        const tick = () => {
          i++;
          el.textContent = text.slice(0, i);
          if (i < text.length) {
            setTimeout(tick, speed);
          } else {
            resolve();
          }
        };
        tick();
      });
    }

    async function typeAllLines(){
      const els = resetLines();
      for (let i=0;i<els.length;i++){
        const el = els[i];
        const text = WISH_LINES[i] || "";
        el.classList.add("show");      // gi·ªØ transition hi·ªán d√≤ng
        await typeLine(el, text, 38);  // g√µ t·ª´ng k√Ω t·ª±
        await new Promise(r=>setTimeout(r, 420));
      }
    }

    btnOpenGift.addEventListener("click", async ()=>{
      await unlockMusic();
      startImageRain();

      popup2.classList.remove("show");
      modal.classList.add("show");

      // ch·∫°y ch·ªØ t·ª´ng k√Ω t·ª±
      typeAllLines();
    });

    btnClose.addEventListener("click", ()=> modal.classList.remove("show"));
    modal.addEventListener("click", (e)=>{ if(e.target === modal) modal.classList.remove("show"); });
  </script>
</body>
</html>
